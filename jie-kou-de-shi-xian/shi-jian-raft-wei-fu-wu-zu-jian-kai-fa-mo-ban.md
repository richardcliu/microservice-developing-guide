---
description: 'https://git.oa.com/raft/raft-microservice-template-go'
---

# å®è·µï¼šRAFTå¾®æœåŠ¡ç»„ä»¶å¼€å‘æ¨¡æ¿

### ç›®å½• <a id="%E7%9B%AE%E5%BD%95"></a>

* [ğŸ‘‘ é¡¹ç›®ç‰¹ç‚¹](data:text/html;charset=utf-8,%3C%21DOCTYPE%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%20style%3D%22width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3Chead%3E%0D%0A%09%3Ctitle%3EVirtual%20Document%3C%2Ftitle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%20style%3D%22margin%3A%200%3B%20overflow%3A%20hidden%3B%20width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E#crown-%E9%A1%B9%E7%9B%AE%E7%89%B9%E7%82%B9)
* [âœˆï¸ å¿«é€Ÿå¼€å§‹](data:text/html;charset=utf-8,%3C%21DOCTYPE%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%20style%3D%22width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3Chead%3E%0D%0A%09%3Ctitle%3EVirtual%20Document%3C%2Ftitle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%20style%3D%22margin%3A%200%3B%20overflow%3A%20hidden%3B%20width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E#airplane-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B)
* [ğŸ“‚ ç›®å½•ç»“æ„](data:text/html;charset=utf-8,%3C%21DOCTYPE%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%20style%3D%22width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3Chead%3E%0D%0A%09%3Ctitle%3EVirtual%20Document%3C%2Ftitle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%20style%3D%22margin%3A%200%3B%20overflow%3A%20hidden%3B%20width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E#open_file_folder-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84)
* [ğŸ’» åŸºæœ¬å‘½ä»¤](data:text/html;charset=utf-8,%3C%21DOCTYPE%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%20style%3D%22width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3Chead%3E%0D%0A%09%3Ctitle%3EVirtual%20Document%3C%2Ftitle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%20style%3D%22margin%3A%200%3B%20overflow%3A%20hidden%3B%20width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E#computer-%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4)
* [ğŸ’¡ æœåŠ¡å®ç°](data:text/html;charset=utf-8,%3C%21DOCTYPE%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%20style%3D%22width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3Chead%3E%0D%0A%09%3Ctitle%3EVirtual%20Document%3C%2Ftitle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%20style%3D%22margin%3A%200%3B%20overflow%3A%20hidden%3B%20width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E#bulb-%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0)
* [ğŸš¢ é›†æˆéƒ¨ç½²](data:text/html;charset=utf-8,%3C%21DOCTYPE%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%20style%3D%22width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3Chead%3E%0D%0A%09%3Ctitle%3EVirtual%20Document%3C%2Ftitle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%20style%3D%22margin%3A%200%3B%20overflow%3A%20hidden%3B%20width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E#ship-%E9%9B%86%E6%88%90%E9%83%A8%E7%BD%B2)
* [â“ Q & A](data:text/html;charset=utf-8,%3C%21DOCTYPE%20html%3E%0D%0A%3Chtml%20lang%3D%22en%22%20style%3D%22width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3Chead%3E%0D%0A%09%3Ctitle%3EVirtual%20Document%3C%2Ftitle%3E%0D%0A%3C%2Fhead%3E%0D%0A%3Cbody%20style%3D%22margin%3A%200%3B%20overflow%3A%20hidden%3B%20width%3A%20100%25%3B%20height%3A%20100%25%22%3E%0D%0A%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E#question-q--a)

### ğŸ‘‘ é¡¹ç›®ç‰¹ç‚¹ <a id="crown-%E9%A1%B9%E7%9B%AE%E7%89%B9%E7%82%B9"></a>

* ã€äº”è„ä¿±å…¨çš„éº»é›€ã€‘ä»…æœ‰200è¡Œæ ¸å¿ƒä»£ç ï¼Œæä¾›å¿«é€Ÿå¼€å‘ã€é›†æˆã€è°ƒè¯•ã€æ–‡æ¡£ã€ä¸éƒ¨ç½²å¾®æœåŠ¡æ‰€ç”¨åˆ°çš„å„é¡¹èƒ½åŠ›ã€‚
* ã€æ ‡å‡†é«˜æ•ˆçš„æ¥å£ã€‘ä¸€å¥—å®ç°åŒæ—¶å¯¹å¤–æä¾› gRPCã€RESTfull æ¥å£ï¼ˆåç»­æ”¯æŒtRPCï¼‰ï¼Œå®ç°è¿‡ç¨‹ç±»ä¼¼â€œå¡«ç©ºé¢˜â€ã€‚
* ã€æ¸…æ™°æ˜“æ‡‚çš„ä»£ç ã€‘é›†æˆ swagger-uiï¼Œç”¨æˆ·åœ¨å®šä¹‰æ¥å£åè‡ªåŠ¨ç”Ÿæˆæ¥å£æ–‡æ¡£å’Œè°ƒè¯•å·¥å…·ã€‚
* ã€å†…éƒ¨èµ„æºçš„é›†æˆã€‘æ•´åˆSTEKã€OCIã€ä¼ä¸šå¾®ä¿¡ç­‰è…¾è®¯å†…å…¬å¸èµ„æº

å¦‚æœä½ æƒ³å°½å¿«äº†è§£ä¸€ä¸‹é¡¹ç›®ï¼Œ ä¹Ÿå¯ä»¥ç‚¹å‡»è¿™ä¸ªåœ°å€åœ¨STKEä¸Šä½“éªŒï¼š[DEMO åœ¨çº¿ä½“éªŒ](http://9.148.192.215/)

### âœˆï¸ å¿«é€Ÿå¼€å§‹ <a id="airplane-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"></a>

å…ˆå°†gitåº“æ‹‰å–åˆ°æœ¬åœ°

```text
git clone http://git.code.oa.com/raft/raft-microservice-template-go.git
cd raft-microservice-template-go
```

å¯åŠ¨å¹¶å¾®æœåŠ¡ä»…éœ€åœ¨å‘½ä»¤è¡Œä¸­ç®€å•æ‰§è¡Œ

```text
# æˆ– make run
make
```

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ [http://127.0.0.1:8811](http://127.0.0.1:8811/) å³å¯æŸ¥çœ‹æ¥å£æ–‡æ¡£å¹¶è°ƒè¯•æ¥å£  
ï¼ˆè¿œç¨‹æœåŠ¡å™¨ä¸Šéœ€å°†127.0.0.1æ”¹ä¸ºå®é™…æœåŠ¡å™¨çš„åœ°å€ï¼‰ã€‚

### ğŸ“‚ ç›®å½•ç»“æ„ <a id="open_file_folder-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"></a>

```text
.
â”œâ”€â”€ main.go         # å…¥å£æ–‡ä»¶
â”œâ”€â”€ Makefile        # æ„å»ºæ–‡ä»¶
â”œâ”€â”€ proto
â”‚   â””â”€â”€ proto.proto # åè®®æ–‡ä»¶ï¼Œå®šä¹‰æ‰€éœ€è¦çš„gRPCå’ŒRESTæ¥å£
â”œâ”€â”€ server
â”‚   â”œâ”€â”€ framework.go
â”‚   â””â”€â”€ server.go   # æœåŠ¡å®ç°ï¼Œå®ç°gRPCå’ŒRESTæœåŠ¡
â”œâ”€â”€ .orange-ci.yml  # æŒç»­é›†æˆæ–‡ä»¶ï¼Œ ç”¨äºéƒ¨ç½²é¡¹ç›®åˆ°STKE
â”œâ”€â”€ ...
â”œâ”€â”€ ...
â””â”€â”€ third_party
    â””â”€â”€ OpenAPI     # swagger-ui ç”¨äºæ–‡æ¡£å±•ç¤ºå’Œæ¥å£è°ƒè¯•
```

### ğŸ’» åŸºæœ¬å‘½ä»¤ <a id="computer-%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"></a>

æœ¬æ¨¡æ¿å·¥ç¨‹ä½¿ç”¨Makefileæ„å»ºå·¥ç¨‹ï¼Œå…·ä½“å¯ä»¥æ‰“å¼€å¹¶å‚è€ƒå·¥ç¨‹æ ¹ç›®å½•ä¸‹çš„Makefileæ–‡ä»¶  
åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯ä»¥æ„å»ºå¹¶å¯åŠ¨æœåŠ¡

**1. æ„å»ºå¹¶å¯åŠ¨æœåŠ¡**

```text
# æˆ– make run
make
```

**2. ä»…æ„å»ºå·¥ç¨‹ï¼ˆå¹¶ç”Ÿæˆåè®®å’Œæ–‡æ¡£ï¼‰**

```text
make build
```

**3. ä»…è¿è¡Œå·¥ç¨‹**

```text
go run main.go
```

**4. ä»…ç”Ÿæˆåè®®å’Œæ–‡æ¡£**

```text
make generate
```

**5. ç”Ÿæˆdockeré•œåƒ**

```text
make docker
```

### ğŸ’¡ æœåŠ¡å®ç° <a id="bulb-%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0"></a>

**STEP 1. ä¿®æ”¹proto.protoæ–‡ä»¶**  
åœ¨proto.protoæ–‡ä»¶ä¸­å¢åŠ æ¥å£

```text
service UserService {
 
    rpc AddUser(AddUserRequest) returns (User) {
      option (google.api.http) = {
        // Route to this method from POST requests to /api/v1/users
        post: "/api/v1/users"
        body: "*"
      };
      option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
        summary: "å¢åŠ ä¸€ä¸ªç”¨æˆ·"
        description: "å‘æ•°æ®åº“ä¸­å¢åŠ ä¸€ä¸ªç”¨æˆ·."
        tags: "Users"
      };
    }
}
```

**STEP 2. ç¼–è¯‘gRPCæ¥å£æ–‡ä»¶**

```text
make generate
```

**STEP 3. ä¿®æ”¹gRPCæ³¨å†Œä»£ç **  
ç”Ÿæˆå®ŒgRPCåè®®åï¼Œ è¿˜éœ€è¦æ ¹æ®æœåŠ¡çš„åå­—ä¿®æ”¹å°‘é‡çš„æœåŠ¡æ³¨å†Œä»£ç ã€‚

åœ¨framework.goä¸­æœ‰å¦‚ä¸‹ä¸¤å¥éœ€è¦ä¿®æ”¹ï¼Œä¿®æ”¹æˆå¯¹åº”çš„æœåŠ¡åç§°ã€‚  
å¦‚ SafeService æ”¹æˆ RegisterSafeServiceServer

```text
func ListenAndServeGRPC(address string) error {
	...
	proto.RegisterUserServiceServer(grpcServer, &s)
    ...
}

func ListenAndServeREST(restAddress, grpcAddress string, swagger_ui bool) error {
    ...
	err := proto.RegisterUserServiceHandlerFromEndpoint(
		ctx,
		mux,
		grpcAddress,
		opts,
	)
    ...
}
```

**STEP 4. å®ç°æœåŠ¡**  
åœ¨ server.go æ–‡ä»¶ä¸­æ·»åŠ æœåŠ¡çš„å®ç°ä»£ç 

```text
type Server struct{}

func (b *Server)DelUser(context.Context, *proto.DelUserRequest) (*proto.DelUserResponse, error){
	return &proto.DelUserResponse{}, nil
}


func (b *Server) AddUser(ctx context.Context, _ *proto.AddUserRequest) (*proto.User, error) {
	return &proto.User{}, nil
}

func (b *Server) ListUsers(_ *proto.ListUsersRequest, srv proto.UserService_ListUsersServer) error {
	return nil
}


```

**STEP 5. å¯åŠ¨æœåŠ¡**

```text
# æˆ– make run
make
```

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ [http://127.0.0.1:8811](http://127.0.0.1:8811/) å³å¯æŸ¥çœ‹æ¥å£æ–‡æ¡£å¹¶è°ƒè¯•æ¥å£  
ï¼ˆè¿œç¨‹æœåŠ¡å™¨ä¸Šéœ€å°†127.0.0.1æ”¹ä¸ºå®é™…æœåŠ¡å™¨çš„åœ°å€ï¼‰ã€‚

### ğŸš¢ é›†æˆéƒ¨ç½² <a id="ship-%E9%9B%86%E6%88%90%E9%83%A8%E7%BD%B2"></a>

é¡¹ç›®ä¸­ç›®å‰å·²ç»é›†æˆäº†Dockerå’ŒOCIï¼Œå¹¶åªéœ€ç®€å•é…ç½®åæäº¤ä»£ç ï¼Œæ—¢å¯ä»¥åœ¨STKEä¸Šéƒ¨ç½²é¡¹ç›®ã€‚

**STEP 1. GITä»“åº“æˆæƒ**  
æè¿°äº†å½“ä»“åº“å‘ç”Ÿä¸€äº›äº‹ä»¶æ—¶ï¼Œ`Orange-ci` åº”è¯¥å¦‚ä½•å»è¿›è¡Œå¤„ç†ã€‚  
å› æ­¤ `Orange-ci`å·¥å…·éœ€è¦ä½¿ç”¨gitä»“åº“æˆæƒï¼Œç‚¹å‡»ä¸‹é¢é“¾æ¥è¿›è¡Œæˆæƒï¼š  
[OAuth2 æˆæƒ](http://orange-ci.oa.com/oauth/authorize)

**STEP 2. å¢åŠ ä¿®æ”¹OCIé…ç½®æ–‡ä»¶**  
é€šå¸¸ï¼Œçº¦å®šé…ç½®æ–‡ä»¶å‘½åä¸º `.orange-ci.yml`ï¼Œæ­¤æ–‡ä»¶å·²ç»ç¼–å†™å¥½ï¼Œå¹¶æ”¾ç½®åœ¨äº†å·¥ç¨‹ç›®å½•ä¸‹ã€‚

å¤§éƒ¨åˆ†ä¿¡æ¯å·²ç»é…ç½®å¥½äº†ï¼Œ å¼€å‘è€…å¯ä»¥ç®€å•çš„å¡«å†™å¦‚ä¸‹å‡ é¡¹

```text
  # æ›´æ–° stke
  - name: stke update
    type: stke:update
    options:
      kind: deployment
      projectName: XXXX  ## è¿™é‡Œä¿®æ”¹æˆSTKEä¸Šçš„ å·¥ç¨‹åå­—
      namespaces: XXXX   ## è¿™é‡Œä¿®æ”¹æˆSTKEä¸Šçš„ åå­—ç©ºé—´
      clusterId: XXXX    ## è¿™é‡Œä¿®æ”¹æˆSTKEä¸Šçš„ é›†ç¾¤ID
      resourceIns: XXXX  ## è¿™é‡Œä¿®æ”¹æˆSTKEä¸Šçš„ èµ„æºå®ä¾‹
      name: demo-container
```

å¦‚ä¸‹ä¸¤ä¸ªæ ‡ç­¾çš„åœ°å€å¯ä»¥æ”¹æˆè‡ªå·±ç”³è¯·çš„dockerè¿›é¡¹çš„å­˜å‚¨åœ°å€ï¼ˆç®€å•æµ‹è¯•ä¹Ÿå¯ä»¥ä¸æ”¹ï¼‰

```text
  # åˆ›å»ºä¸¤ä¸ªæ ‡ç­¾ï¼Œå¤šå‡ºä¸€ä¸ªä½œä¸ºå†å²ç‰ˆæœ¬
  - name: create DOCKER_LATEST_TAG
    script: echo -n csighub.tencentyun.com/raft/raft-microservice-demo:latest
    envExport:
      info: DOCKER_LATEST_TAG
  - name: create DOCKER_TIME_TAG
    script: echo -n csighub.tencentyun.com/raft/raft-microservice-demo:$(date "+%Y%m%d%H%M")
    envExport:
      info: DOCKER_TIME_TAG
```

**STEP 3. æäº¤ä»£ç ï¼Œ è§¦å‘è‡ªåŠ¨æ„å»º**  
ä¹‹åæäº¤ä»£ç ã€‚ æ„å»ºå°†è‡ªåŠ¨å¼€å§‹ï¼Œ å¹¶éƒ¨ç½²åˆ°STKEã€‚  
éƒ¨ç½²å’Œæ„å»ºè¿‡ç¨‹ä¼šç”±ä¼ä¸šå¾®ä¿¡é€šçŸ¥åˆ°ä½ ã€‚

### â“ Q & A <a id="question-q-a"></a>

Q&A æš‚æ—¶è¿˜æ²¡æœ‰å®ç°ç¼–å†™ï¼Œ å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·å½“é¢æ‰¾ç†æŸ¥å¾·è§£å†³ã€‚ğŸ·

